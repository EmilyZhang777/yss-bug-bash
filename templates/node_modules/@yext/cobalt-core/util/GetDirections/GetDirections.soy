{namespace cobalt.util}

/**
 * @param profile
 * @param? relatedData
 * @param? listings
 * @param? provider
 * @param? routing
 */
{template .GetDirections}
  // Address parts to build query
  {let $address1: $profile.address.line1 /}
  {let $address2: $profile.address.line2 /}
  {let $city: $profile.address.city /}
  {let $region: $profile.address.region /}
  {let $postalCode: $profile.address.postalCode /}
  {let $country: $profile.address.countryCode /}
  // Build location query
  {let $search}
    {$address1 |noAutoescape}{if $address2} {$address2 |noAutoescape}{/if} {$city} {$region} {$postalCode}{if $country} {$country}{/if}
  {/let}
  {let $query}{$search |noAutoescape|escapeUri}{/let}

  {let $defaultProvider}{if $provider}{$provider |casing:'lower'}{else}google{/if}{/let}

  // Determine maps provider, and call template
  {switch $defaultProvider}
    {case 'apple'}
      {call .GetDirections_Apple}
        {param query: $query /}
        {param name: $profile.name /}
      {/call}
    {case 'bing'}
      {call .GetDirections_Bing}
        {param query: $query /}
      {/call}
    {default}
      {call .GetDirections_Google}
        {param query: $query /}
        {param listings: $listings ?: ($relatedData?.listings ?: []) /}
        {param routing: $routing /}
      {/call}
  {/switch}
{/template}

/**
 * @param query
 * @param name
 */
{template .GetDirections_Apple}
  {let $root: 'https://maps.apple.com/' /}
  {$root}?address={$query}?q={$name |escapeUri}
{/template}

/**
 * @param query
 */
{template .GetDirections_Bing}
  {let $root: 'https://bing.com/maps/' /}
  {$root}{$query}
{/template}

/**
 * @param query
 * @param listings
 * @param? routing
 */
{template .GetDirections_Google}
  {let $root: 'https://www.google.com/maps/' /}

  {if $routing and $listings.googleMyBusiness?.placeId}
    // Google Place ID + directions from current location
    // A place ID is a textual identifier that uniquely identifies a place. -- https://developers.google.com/places/place-id
    {$root}dir/?api=1&destination_place_id={$listings.googleMyBusiness.placeId}&destination=direct

  {elseif $listings.googleMyBusiness?.url}
    // Google My Business
    // Location based business profile -- https://www.google.com/business/
    {$listings.googleMyBusiness.url}

  {elseif $listings.googleMyBusiness?.placeId}
    // Google Place ID
    {$root}search/?api=1&query={$query}&query_place_id={$listings.googleMyBusiness.placeId}

  {elseif $listings.googleReviews?.url}
    // Google reviews
    // Get reviews directly on Google -- https://support.google.com/business/answer/3474122?hl=en&ref_topic=6109351
    {$listings.googleReviews.url}

  {else}
    // General location query
    {if $routing}
      {$root}dir/Current+Location/{$query}
    {else}
      {$root}search/?api=1&query={$query}
    {/if}

  {/if}
{/template}

